name: Build WDM Driver

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download and Mount EWDK
      run: |
        Invoke-WebRequest -Uri "https://go.microsoft.com/fwlink/?linkid=2251231" -OutFile "ewdk.iso"
        $mountResult = Mount-DiskImage -ImagePath "ewdk.iso" -PassThru
        $driveLetter = ($mountResult | Get-Volume ).DriveLetter
        echo "EWDK_DRIVE=$($driveLetter):" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Build Driver
      id: build
      run: |
        call %EWDK_DRIVE%\LaunchBuildEnv.cmd
        build.exe -cZ
      shell: cmd

    - name: Upload Driver Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MyDriver-artifact
        path: objfre_win7_amd64/amd64/Driver.sys
